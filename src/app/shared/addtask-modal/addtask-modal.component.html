<section class="add-task-wrapper" role="main" aria-labelledby="addTaskTitle">
  <h2 id="addTaskTitle">Add Task</h2>

  <section class="form" role="form" aria-label="Task creation form">
    <div class="addTaskForm" role="group" aria-labelledby="taskBasics">
      <h3 id="taskBasics" class="visually-hidden">Basic Task Information</h3>

      <div class="title-field">
        <label for="titleInput">Title<span class="warning" aria-hidden="true">*</span></label>
        <input id="titleInput" [(ngModel)]="title" type="text" placeholder="Enter a title" (blur)="titleTouched= true"
          aria-required="true" aria-invalid="!title && titleTouched" />
        <div class="input-hint" role="alert" aria-live="polite">
          @if (!title && titleTouched) {
          <span>Please enter a title</span>
          }
        </div>
      </div>

      <div class="description-field">
        <label for="description">Description</label>
        <textarea [(ngModel)]="description" rows="5" name="description" id="description"
          placeholder="Enter a Description" aria-label="Task description"></textarea>
      </div>

      <div class="date-field">
        <label for="dateInput">Due date<span class="warning" aria-hidden="true">*</span></label>
        <div class="input-wrapper">
          <input id="dateInput" matInput [matDatepicker]="picker" [(ngModel)]="date" [min]="minDate"
            placeholder="dd/mm/yyyy" (blur)="dateTouched = true" (focus)="picker.open()" aria-required="true"
            aria-invalid="!date && dateTouched">
          <mat-datepicker-toggle matSuffix [for]="picker" aria-label="Open date picker">
            <img matDatepickerToggleIcon src="/assets/images/board/calender.svg" alt="" aria-hidden="true">
          </mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </div>
      </div>
    </div>

    <div class="border" role="separator"></div>

    <div class="taskOptions" role="group" aria-labelledby="taskDetails">
      <h3 id="taskDetails" class="visually-hidden">Task Details</h3>

      <div class="prio-wrapper" role="group" aria-labelledby="priorityLabel">
        <p id="priorityLabel">Priority</p>
        <div class="prio-btn-container" role="radiogroup" aria-label="Task priority">
          <button class="urgent" [ngClass]="{'active': selectedPrio === 'urgent'}" (click)="selectPrio('urgent')"
            role="radio" [attr.aria-checked]="selectedPrio === 'urgent'">
            Urgent
            <img src="/assets/images/board/prio-urgent.svg" alt="" aria-hidden="true">
          </button>
          <button class="medium" [ngClass]="{'active': selectedPrio === 'medium'}" (click)="selectPrio('medium')">Medium
            <img src="/assets/images/board/prio-medium.svg" alt=""></button>
          <button class="low" [ngClass]="{'active': selectedPrio == 'low'}" (click)="selectPrio('low')">Low <img
              src="/assets/images/board/prio-low.svg" alt=""></button>
        </div>
      </div>

      <div class="assignedTo-wrapper" role="group" aria-labelledby="assignLabel">
        <p id="assignLabel">Assigned to</p>
        <div class="custom-select" role="combobox" [attr.aria-expanded]="contactDropDownOpen" aria-haspopup="listbox"
          aria-controls="contactsList">
          <div class="selected" (click)="contactDropDownOpen = !contactDropDownOpen">
            <span>Select contacts to assign</span>
            <img src="/assets/images/board/arrow_drop_down.svg" alt="">
          </div>
          @if (contactDropDownOpen) {
          <div class="dropdown" (mousedown)="$event.preventDefault()">
            @for (group of contactlist.getGroupedContacts(); track group.letter) {
            <div class="group">
              @for (contact of group.contacts; track contact.id) {
              <label class="dropdown-option" [class.selected]="isSelected(contact)" (click)="toggleContact(contact)">
                <span class="contact-initials" [style.background]="getColorForLetter(contact.firstName.charAt(0))">
                  {{ contact.firstName.charAt(0).toUpperCase() }}{{ contact.lastName.charAt(0).toUpperCase() }}
                </span>
                <span class="contact-name">
                  {{ contact.firstName }} {{ contact.lastName }}
                </span>
                <span class="checkbox-container" (click)="$event.stopPropagation()">
                  <input type="checkbox" [checked]="isSelected(contact)" (change)="toggleContact(contact)">
                </span>
              </label>
              }
            </div>
            }
          </div>
          }
        </div>
        @if (selectedContacts.length > 0) {
        <div class="selected-contacts-initials">
          @for (contact of selectedContacts; track contact.id) {
          <span class="contact-initials" [style.background]="getColorForLetter(contact.firstName.charAt(0))">
            {{ contact.firstName.charAt(0).toUpperCase() }}{{ contact.lastName.charAt(0).toUpperCase() }}
          </span>
          }
        </div>
        }
      </div>

      <div class="category-wrapper">
        <p>Category<span class="warning">*</span></p>
        <div class="custom-select" tabindex="0" (blur)="onCategoryBlur()">
          <div class="selected" (click)="categoryDropDownOpen = !categoryDropDownOpen">
            @if (!category) {
            <span>Select task category</span>
            }
            @if (category) {
            <span>{{ category }}</span>
            }
            <img src="/assets/images/board/arrow_drop_down.svg" alt="">
          </div>
          @if (categoryDropDownOpen) {
          <div class="dropdown" (mousedown)="$event.preventDefault()">
            <div (click)="category = 'Technical Task'; categoryDropDownOpen = false" class="dropdown-option">Technical
              Task
            </div>
            <div (click)="category = 'User Story'; categoryDropDownOpen = false" class="dropdown-option">User Story
            </div>
          </div>
          }
        </div>
        <div class="input-hint">
          @if (!category && categoryTouched) {
          <span role="alert">Please enter a valid category</span>}
        </div>
      </div>

      <div class="subtasks-wrapper" role="group" aria-labelledby="subtasksLabel">
        <label id="subtasksLabel" for="subtasks">Subtasks</label>
        <div class="input-wrapper">
          <input [(ngModel)]="newSubtask" id="subtasks" type="text" placeholder="Add new subtask"
            (keyup.enter)="addSubtask()" (focus)="showSubtaskControls()" (blur)="onSubtaskBlur()" #subtaskInput
            aria-label="New subtask input">

          <button class="add-subtask-btn" (click)="showSubtaskControls()" aria-label="Add subtask">
            <img src="/assets/images/board/add.svg" [class.hide]="isSubtaskActive" alt="" aria-hidden="true">
          </button>
        </div>

        @if (subtasks.length > 0) {
        <ul class="subtasks-list" role="list" aria-label="Subtasks list">
          @for (subtask of subtasks; track subtask; let i = $index) {
          <li class="subtask-item" role="listitem">
            <span>{{ subtask }}</span>
            <div class="subtask-single-item-icons">
              <button aria-label="Edit subtask">
                <img src="/assets/images/board/edit.svg" alt="" aria-hidden="true">
              </button>
              <div class="border" role="separator"></div>
              <button (click)="removeSubtask(i)" aria-label="Delete subtask">
                <img src="/assets/images/board/delete.svg" alt="" aria-hidden="true">
              </button>
            </div>
          </li>
          }
        </ul>
        }
      </div>
    </div>
  </section>

  <section class="form-footer">
    <p role="note"><span class="warning" aria-hidden="true">*</span>This field is required</p>
    <div class="button-container">
      <button (click)="clearForm()" class="button-white-border" aria-label="Clear form">
        <span>Clear</span>
        <img src="/assets/images/icons/icon-cancel.svg" alt="" aria-hidden="true">
      </button>
      <button (click)="addTaskToDBViaTemplateClick()" class="button-blue" [disabled]="!title || !date || !category"
        aria-label="Create task">
        <span>Create Task</span>
        <img src="/assets/images/icons/icon-check.svg" alt="" aria-hidden="true">
      </button>
    </div>
  </section>

  @if(showSuccessMessage){
  <div class="success-message-container" role="alert" aria-live="polite">
    {{successMessage}}
  </div>
  }
</section>
