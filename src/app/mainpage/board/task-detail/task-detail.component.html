<div class="overlay" [ngClass]="{'visible': isVisible, 'hidden': !isVisible}" (click)="close()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="task-detail-container">
      <div class="task-header">
        <div class="category-badge" [ngClass]="task?.category?.toLowerCase()">
          {{ isEditMode ? editCategory : task?.category }}
        </div>
        <div class="close-btn-wrapper" (click)="close()">
          <img class="close-btn" src="/assets/images/contactform/cancel.svg" alt="close button">
        </div>
      </div>

      <div class="task-content">
        <div *ngIf="!isEditMode">
          <h2 class="task-title">{{ task?.title }}</h2>
          <p class="task-description">{{ task?.description }}</p>

          <div class="task-meta">
            <div class="meta-item">
              <span class="meta-label">Due date:</span>
              <span class="meta-value">{{ task?.date?.toDate() | date:'dd/MM/yyyy' }}</span>
            </div>
            
            <div class="meta-item">
              <span class="meta-label">Priority:</span>
              <div class="priority-container">
                <span class="meta-value priority-text">{{ task?.priority | titlecase }}</span>
                <img [src]="getPriorityIcon()" alt="priority icon" class="priority-icon">
              </div>
            </div>
          </div>

          <div class="assigned-to-section" *ngIf="hasAssignedUsers">
            <span class="section-label">Assigned To:</span>
            <div class="assigned-users">
              <div class="user-item" *ngFor="let user of assignedUsers">
                <div class="user-badge">{{ user.substring(0, 2).toUpperCase() }}</div>
                <span class="user-name">{{ user }}</span>
              </div>
            </div>
          </div>

          <div class="subtasks-section" *ngIf="hasSubtasks">
            <span class="section-label">Subtasks</span>
            <div class="subtasks-list">
              <div class="subtask-item" *ngFor="let subtask of subtasks; let i = index" (click)="toggleSubtask(i)">
                <div class="checkbox" [ngClass]="{'checked': subtask.done}">
                  <img *ngIf="subtask.done" src="/assets/images/icons/icon-check.svg" alt="checked">
                </div>
                <span class="subtask-text" [ngClass]="{'completed': subtask.done}">{{ subtask.title }}</span>
              </div>
            </div>
          </div>

          <div class="task-actions">
            <button class="action-btn delete-btn" (click)="deleteTask()">
              <img src="/assets/images/icons/icon-delete.svg" alt="delete icon">
              <span>Delete</span>
            </button>
            <div class="divider"></div>
            <button class="action-btn edit-btn" (click)="editTask()">
              <img src="/assets/images/icons/icon-edit.svg" alt="edit icon">
              <span>Edit</span>
            </button>
          </div>
        </div>

        <div *ngIf="isEditMode" class="edit-form">
          <div class="form-group">
            <label for="title">Title*</label>
            <input 
              type="text" 
              id="title"
              [(ngModel)]="editTitle"
              (blur)="titleTouched = true"
              class="form-input"
              [class.error]="titleTouched && !editTitle"
              placeholder="Enter a title">
            <div *ngIf="titleTouched && !editTitle" class="error-message">This field is required</div>
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea 
              id="description"
              [(ngModel)]="editDescription"
              class="form-textarea"
              placeholder="Enter a Description"
              rows="4">
            </textarea>
          </div>

          <div class="form-group">
            <label for="date">Due date*</label>
            <div class="date-input-container">
              <input 
                matInput 
                [matDatepicker]="picker"
                [(ngModel)]="editDate"
                (blur)="dateTouched = true"
                class="form-input"
                [class.error]="dateTouched && !editDate"
                placeholder="dd/mm/yyyy">
              <mat-datepicker-toggle [for]="picker"></mat-datepicker-toggle>
            </div>
            <mat-datepicker #picker></mat-datepicker>
            <div *ngIf="dateTouched && !editDate" class="error-message">This field is required</div>
          </div>

          <div class="form-group">
            <label>Priority</label>
            <div class="priority-buttons">
              <button 
                type="button"
                class="priority-btn urgent"
                [class.active]="editPriority === 'urgent'"
                (click)="selectPrio('urgent')">
                Urgent
                <img src="/assets/images/board/prio-urgent.svg" alt="urgent">
              </button>
              <button 
                type="button"
                class="priority-btn medium"
                [class.active]="editPriority === 'medium'"
                (click)="selectPrio('medium')">
                Medium
                <img src="/assets/images/board/prio-medium.svg" alt="medium">
              </button>
              <button 
                type="button"
                class="priority-btn low"
                [class.active]="editPriority === 'low'"
                (click)="selectPrio('low')">
                Low
                <img src="/assets/images/board/prio-low.svg" alt="low">
              </button>
            </div>
          </div>

          <div class="form-group">
            <label>Assigned to</label>
            <div class="custom-select" tabindex="0" (blur)="contactDropDownOpen = false">
              <div class="selected" (click)="contactDropDownOpen = !contactDropDownOpen">
                <span>Select contacts to assign</span>
                <img src="/assets/images/board/arrow_drop_down.svg" alt="">
              </div>
              @if (contactDropDownOpen) {
              <div class="dropdown" (mousedown)="$event.preventDefault()">
                @for (group of contactService.getGroupedContacts(); track group.letter) {
                <div class="group">
                  @for (contact of group.contacts; track contact.id) {
                  <label class="dropdown-option" [class.selected]="isSelected(contact)" (click)="toggleContact(contact)">
                    <span class="contact-initials" [style.background]="getColorForLetter(contact.firstName.charAt(0))">
                      {{ contact.firstName.charAt(0).toUpperCase() }}{{ contact.lastName.charAt(0).toUpperCase() }}
                    </span>
                    <span class="contact-name">
                      {{ contact.firstName }} {{ contact.lastName }}
                    </span>
                    <span class="checkbox-container" (click)="$event.stopPropagation()">
                      <input type="checkbox" [checked]="isSelected(contact)" (change)="toggleContact(contact)">
                    </span>
                  </label>
                  }
                </div>
                }
              </div>
              }
            </div>
            @if (selectedContacts.length > 0) {
            <div class="selected-contacts-initials">
              @for (contact of selectedContacts; track contact.id) {
              <span class="contact-initials" [style.background]="getColorForLetter(contact.firstName.charAt(0))">
                {{ contact.firstName.charAt(0).toUpperCase() }}{{ contact.lastName.charAt(0).toUpperCase() }}
              </span>
              }
            </div>
            }
          </div>

          <div class="form-group">
            <label for="category">Category*</label>
            <div class="dropdown-container">
              <input 
                type="text"
                class="form-input dropdown-input"
                [(ngModel)]="editCategory"
                (focus)="categoryDropDownOpen = true"
                (blur)="onCategoryBlur()"
                [class.error]="categoryTouched && !editCategory"
                placeholder="Select task category"
                readonly>
              
              <div class="dropdown-content" *ngIf="categoryDropDownOpen">
                <div class="dropdown-item" (click)="editCategory = 'Technical Task'; categoryDropDownOpen = false">
                  <span>Technical Task</span>
                </div>
                <div class="dropdown-item" (click)="editCategory = 'User Story'; categoryDropDownOpen = false">
                  <span>User Story</span>
                </div>
              </div>
            </div>
            <div *ngIf="categoryTouched && !editCategory" class="error-message">This field is required</div>
          </div>

          <div class="form-group">
            <label>Subtasks</label>
            <div class="subtasks-input">
              <input 
                type="text"
                class="form-input"
                placeholder="Add new subtask"
                #subtaskInput
                (keyup.enter)="addSubtask(subtaskInput.value); subtaskInput.value = ''">
              <button 
                type="button"
                class="add-subtask-btn"
                (click)="addSubtask(subtaskInput.value); subtaskInput.value = ''">
                +
              </button>
            </div>
            
            <div class="subtasks-list" *ngIf="editSubtasks.length > 0">
              <div class="subtask-item" *ngFor="let subtask of editSubtasks; let i = index">
                <div class="checkbox" [class.checked]="subtask.done" (click)="toggleEditSubtask(i)">
                  <img *ngIf="subtask.done" src="/assets/images/icons/icon-check.svg" alt="checked">
                </div>
                <span class="subtask-text" [class.completed]="subtask.done">{{ subtask.title }}</span>
                <div class="subtask-actions">
                  <button type="button" class="edit-subtask-btn" (click)="editSubtask(i)">
                    <img src="/assets/images/icons/icon-edit.svg" alt="edit">
                  </button>
                  <div class="divider"></div>
                  <button type="button" class="delete-subtask-btn" (click)="removeSubtask(i)">
                    <img src="/assets/images/icons/icon-delete.svg" alt="delete">
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="edit-actions">
            <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
              Cancel
            </button>
            <button 
              type="button" 
              class="button-blue"
              [disabled]="!validateForm()"
              (click)="saveTask()">
              <span>Ok</span>
              <img src="/assets/images/icons/icon-check.svg" alt="check icon">
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
